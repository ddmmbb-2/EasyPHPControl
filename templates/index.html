<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apache ç®¡ç†å“¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        
        /* è®“è¡¨æ ¼å‚ç›´ç½®ä¸­ */
        .table td { vertical-align: middle; }
    </style>
</head>
<body>

{% raw %}
<div id="app" class="container-fluid">
    
    <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center py-2">
            <h5 class="m-0 fw-bold">Apache Server Manager</h5>
            <div>
                <span class="status-dot" :class="{'status-green': isRunning, 'status-red': !isRunning}"></span>
                <span class="me-3 fw-bold">{{ isRunning ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢' }}</span>
                <button class="btn btn-sm btn-success" @click="controlApache('start')" :disabled="isRunning">å•Ÿå‹•</button>
                <button class="btn btn-sm btn-danger" @click="controlApache('stop')" :disabled="!isRunning">åœæ­¢</button>
                <button class="btn btn-sm btn-warning" @click="controlApache('restart')" :disabled="!isRunning">é‡å•Ÿ</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <strong>ç¶²ç«™èˆ‡é€£æ¥åŸ è¨­å®š</strong>
            <button class="btn btn-primary btn-sm" @click="addSite">ï¼‹ æ–°å¢ç¶²ç«™</button>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0 text-center">
                <thead class="table-light">
                    <tr>
                        <th style="width: 10%">æ¨¡å¼</th>
                        <th style="width: 20%">ç¶²åŸŸ (Domain)</th>
                        <th style="width: 10%">ç›£è½ Port</th>
                        <th style="width: 40%">ç›®æ¨™ (è·¯å¾‘ æˆ– IP)</th>
                        <th style="width: 10%">SSL</th>
                        <th style="width: 10%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(site, index) in sites" :key="index">
                        <td>
                            <select v-model="site.type" class="form-select form-select-sm">
                                <option value="proxy">åå‘ä»£ç†</option>
                                <option value="dir">æœ¬åœ°ç›®éŒ„</option>
                            </select>
                        </td>

                        <td>
                            <input type="text" v-model="site.domain" class="form-control form-control-sm" placeholder="ä¾‹å¦‚ localhost">
                        </td>

                        <td>
                            <input type="number" v-model="site.port" class="form-control form-control-sm" placeholder="80">
                        </td>

                        <td class="text-start">
                            <div v-if="site.type === 'proxy'" class="input-group input-group-sm">
                                <span class="input-group-text">http://</span>
                                <input type="text" v-model="site.target" class="form-control" placeholder="127.0.0.1:3000">
                            </div>
                            
                            <div v-else class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" type="button" @click="browseFolder(site)">ğŸ“‚ ç€è¦½...</button>
                                <input type="text" v-model="site.target" class="form-control" placeholder="é¸æ“‡ç¶²ç«™æ ¹ç›®éŒ„...">
                            </div>
                        </td>

                        <td>
                            <button class="btn btn-outline-info btn-sm" @click="applySSL(site)" 
                                    :disabled="site.domain === 'localhost' || !site.domain"
                                    v-if="!site.ssl_active">
                                ç”³è«‹
                            </button>
                            <span v-else class="badge bg-success">å·²å•Ÿç”¨</span>
                        </td>

                        <td>
                            <button class="btn btn-outline-danger btn-sm border-0" @click="removeSite(index)">âœ•</button>
                        </td>
                    </tr>
                    
                    <tr v-if="sites.length === 0">
                        <td colspan="6" class="text-muted py-4">å°šæœªè¨­å®šä»»ä½•ç¶²ç«™ï¼Œè«‹é»æ“Šå³ä¸Šè§’æ–°å¢ã€‚</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="card-footer text-end bg-white">
            <small class="text-muted me-3">ä¿®æ”¹å¾Œè«‹è¨˜å¾—å„²å­˜</small>
            <button class="btn btn-success px-4" @click="saveSites">å„²å­˜è¨­å®šä¸¦é‡å•Ÿ Apache</button>
        </div>
    </div>

</div>
{% endraw %}

<script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isRunning: false,
                sites: []
            }
        },
        mounted() {
            this.checkStatus();
            this.loadSites();
            setInterval(this.checkStatus, 5000);
        },
        methods: {
            async checkStatus() {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();
                    this.isRunning = data.running;
                } catch(e) {}
            },
            async controlApache(action) {
                await fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });
                setTimeout(this.checkStatus, 1000);
            },
            async loadSites() {
                const res = await fetch('/api/sites');
                this.sites = await res.json();
            },
            addSite() {
                this.sites.push({
                    domain: "localhost",
                    type: "dir",       // é è¨­æ”¹æˆè³‡æ–™å¤¾æ¨¡å¼ï¼Œæ¯”è¼ƒç›´è¦º
                    target: "",
                    port: 8080,        // é è¨­ Port
                    ssl_email: ""
                });
            },
            removeSite(index) {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¶²ç«™è¨­å®šå—ï¼Ÿ')) {
                    this.sites.splice(index, 1);
                }
            },
            // [æ–°å¢] å‘¼å«å¾Œç«¯ API é¸æ“‡è³‡æ–™å¤¾
            async browseFolder(site) {
                const res = await fetch('/api/browse');
                const data = await res.json();
                if (data.path) {
                    site.target = data.path; // å°‡è·¯å¾‘å¡«å…¥è©²è¡Œ
                }
            },
            async saveSites() {
                const res = await fetch('/api/sites', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.sites)
                });
                alert('è¨­å®šå·²å„²å­˜ï¼ŒApache æ­£åœ¨é‡å•Ÿ...');
            },
            async applySSL(site) {
                const email = prompt("è«‹è¼¸å…¥ç”¨æ–¼ Let's Encrypt é€šçŸ¥çš„ Email:", site.ssl_email || "");
                if (!email) return;
                
                site.ssl_email = email;
                alert("æ­£åœ¨èƒŒæ™¯å‘¼å« win-acmeï¼Œè«‹ç¨å€™...");
                
                const res = await fetch('/api/ssl', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({domain: site.domain, email: email})
                });
                const data = await res.json();
                alert(data.result);
            }
        }
    }).mount('#app');
</script>
</body>
</html>